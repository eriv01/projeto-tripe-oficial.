<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico TRIPE - Otimiza√ß√£o Ativa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ef4444; --primary-dark: #dc2626; --bg-dark: #0a0a0a; --card-bg: #141414; --text-main: #ffffff; --text-muted: #9ca3af; --border: #262626; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark ); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-card { width: 100%; max-width: 550px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .header { margin-bottom: 32px; }
        .progress-container { margin-bottom: 12px; }
        .progress-info { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        h2 { font-size: 22px; font-weight: 700; line-height: 1.3; margin-bottom: 24px; }
        .options-grid { display: grid; gap: 12px; }
        .option-item { background: transparent; border: 2px solid var(--border); border-radius: 16px; padding: 18px 20px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; text-align: left; width: 100%; color: var(--text-main); font-size: 16px; font-weight: 500; }
        .option-item:hover { border-color: var(--primary); background: rgba(239, 68, 68, 0.05); }
        .option-item.selected { border-color: var(--primary); background: rgba(239, 68, 68, 0.1); }
        .radio-dot { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; margin-right: 16px; position: relative; flex-shrink: 0; }
        .option-item.selected .radio-dot { border-color: var(--primary); }
        .option-item.selected .radio-dot::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .footer { margin-top: 32px; display: flex; gap: 12px; }
        .btn { padding: 16px 24px; border-radius: 14px; font-weight: 700; font-size: 15px; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }
        .btn-next { background: var(--primary); color: white; flex: 2; }
        .btn-next:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-back { background: var(--border); color: var(--text-main); flex: 1; }
        .result-box { text-align: center; }
        .badge { background: rgba(239, 68, 68, 0.1); color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 16px; display: inline-block; }
        .ganho-destaque { font-size: 32px; font-weight: 800; color: var(--primary); margin: 16px 0; }
        .diagnosis-list { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 20px; text-align: left; margin: 24px 0; }
        .diagnosis-item { display: flex; gap: 12px; font-size: 14px; margin-bottom: 12px; }
        .cta-btn { background: var(--primary); color: white; width: 100%; padding: 20px; border-radius: 16px; font-size: 18px; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.4); }
        .loader { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 480px) { .quiz-card { padding: 24px; border-radius: 0; border: none; background: transparent; box-shadow: none; } body { justify-content: flex-start; padding: 0; } }
    </style>
</head>
<body>
    <div class="quiz-card" id="app"><div class="loader"></div></div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, update, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCDYmSVU2xVVuLw0vu3svKI7n4hvdxjW0w",
            authDomain: "projeto-tripe-oficial.firebaseapp.com",
            databaseURL: "https://projeto-tripe-oficial-default-rtdb.firebaseio.com",
            projectId: "projeto-tripe-oficial",
            storageBucket: "projeto-tripe-oficial.firebasestorage.app",
            messagingSenderId: "274742031259",
            appId: "1:274742031259:web:18dc5c086fe3d58b56673e"
        };

        const COPY_VARIANTS = {
            saudacao: [
                "üî¨ Iniciando Diagn√≥stico Cl√≠nico de Potencial de Expans√£o...",
                "üî• ATEN√á√ÉO: Seu protocolo de crescimento est√° sendo gerado.",
                "üí™ Descubra agora o quanto voc√™ ainda pode crescer naturalmente.",
                "‚ö†Ô∏è ALERTA: Identificamos bloqueios no seu desenvolvimento.",
                "‚úÖ Verifica√ß√£o de compatibilidade com o M√©todo TRIPE iniciada."
            ],
            questions: [
                ["Qual o tamanho atual?", "Qual sua medida ereto?", "Qual sua base de partida?", "Quanto voc√™ mede hoje?", "Qual sua estatura atual?"],
                ["Ere√ß√£o matinal frequente?", "Acorda com 'bom dia'?", "Sente rigidez ao acordar?", "Sua testosterona matinal √© alta?", "Tem ere√ß√µes involunt√°rias?"],
                ["J√° tentou algo antes?", "J√° buscou solu√ß√µes?", "√â sua primeira tentativa?", "J√° usou outros m√©todos?", "J√° testou t√©cnicas naturais?"],
                ["Como √© sua alimenta√ß√£o?", "Sua dieta √© limpa?", "Come muitos processados?", "Sua nutri√ß√£o √© equilibrada?", "O que voc√™ come diariamente?"],
                ["Dorme quantas horas?", "Seu sono √© reparador?", "Descansa o suficiente?", "Qual sua m√©dia de sono?", "Dorme bem √† noite?"],
                ["Pratica exerc√≠cios?", "√â uma pessoa ativa?", "Treina com frequ√™ncia?", "Faz atividade f√≠sica?", "Qual seu n√≠vel de sedentarismo?"],
                ["Qual sua faixa et√°ria?", "Quantos anos voc√™ tem?", "Qual sua idade atual?", "Em que fase da vida est√°?", "Qual seu ano de nascimento?"]
            ],
            resultado: [
                "üî¨ DIAGN√ìSTICO CIENT√çFICO CONCLU√çDO",
                "üî• SEU POTENCIAL FOI LIBERADO",
                "‚ö†Ô∏è BLOQUEIOS CR√çTICOS IDENTIFICADOS",
                "‚úÖ PROTOCOLO DE EXPANS√ÉO PRONTO",
                "üí™ RESULTADO DA AN√ÅLISE DE DESEMPENHO"
            ],
            cta: [
                "üî• COME√áAR PROTOCOLO AGORA",
                "üí™ RESOLVER MEU PROBLEMA",
                "‚úÖ GARANTIR MEUS RESULTADOS",
                "üöÄ QUERO CRESCER AGORA",
                "üîì LIBERAR MEU ACESSO"
            ]
        };

        let db, userRef;
        let currentStep = 0;
        let answers = {};
        let selectedVariants = { saudacao: 0, questions: [0,0,0,0,0,0,0], resultado: 0, cta: 0 };
        const sessionId = 'user_' + Date.now( ) + '_' + Math.random().toString(36).substr(2, 5);

        async function trackStep(step, name) { if (userRef) await update(userRef, { currentStep: step, stepName: name, lastUpdate: serverTimestamp() }); }
        
        async function trackMetric(path) {
            const r = ref(db, path);
            const snap = await get(r);
            const val = (snap.val() || 0) + 1;
            const parentPath = path.substring(0, path.lastIndexOf('/'));
            const field = path.split('/').pop();
            await update(ref(db, parentPath), { [field]: val });
        }

        function render() {
            const app = document.getElementById('app');
            // TELA DE SAUDA√á√ÉO (STEP 0)
            if (currentStep === 0) {
                app.innerHTML = '<div class="result-box"><div class="badge">Diagn√≥stico TRIPE</div><h2>' + COPY_VARIANTS.saudacao[selectedVariants.saudacao] + '</h2><p>Responda as pr√≥ximas perguntas para liberar seu resultado personalizado.</p><button class="cta-btn" onclick="window.next()">INICIAR AGORA</button></div>';
                trackStep(0, 'Sauda√ß√£o');
                return;
            }
            if (currentStep > 7) { showResult(app); return; }
            
            const qIdx = currentStep - 1;
            const questionText = COPY_VARIANTS.questions[qIdx][selectedVariants.questions[qIdx]];
            const options = [
                ["Menos de 12 cm", "De 12 a 14 cm", "De 14 a 16 cm", "Mais de 16 cm"],
                ["Quase nunca", "Raramente", "√Äs vezes", "Quase sempre"],
                ["Nunca", "J√° ouvi falar", "J√° tentei", "Sim, com disciplina"],
                ["Lixo", "50/50", "Saud√°vel", "Equilibrada"],
                ["< 5h", "5-6h", "6-7h", "8h+"],
                ["Nunca", "1x/semana", "2-3x/semana", "4x+"],
                ["16-18", "19-27", "28-36", "36+"]
            ][qIdx];
            const id = ['tamanho', 'erecao', 'metodo', 'dieta', 'sono', 'treino', 'idade'][qIdx];

            const progress = Math.round((currentStep / 7) * 100);
            let optionsHtml = options.map(opt => '<button class="option-item ' + (answers[id] === opt ? 'selected' : '') + '" onclick="window.selectOption(\'' + id + '\', \'' + opt + '\')"><div class="radio-dot"></div>' + opt + '</button>').join('');
            
            app.innerHTML = '<div class="header"><div class="progress-container"><div class="progress-info"><span>Pergunta ' + currentStep + ' de 7</span><span>' + progress + '%</span></div><div class="progress-bar"><div class="progress-fill" style="width: ' + progress + '%"></div></div></div><h2>' + questionText + '</h2></div><div class="options-grid">' + optionsHtml + '</div><div class="footer"><button class="btn btn-back" onclick="window.prev()">Voltar</button><button class="btn btn-next" id="nextBtn" ' + (!answers[id] ? 'disabled' : '') + ' onclick="window.next()">Pr√≥ximo</button></div>';
            trackStep(currentStep, 'Pergunta ' + currentStep);
        }

        function showResult(app) {
            const ganho = (Math.random() * (5.0 - 1.5) + 1.5).toFixed(1);
            const ctaText = COPY_VARIANTS.cta[selectedVariants.cta];
            const resTitle = COPY_VARIANTS.resultado[selectedVariants.resultado];
            
            app.innerHTML = '<div class="result-box"><div class="badge">Diagn√≥stico Conclu√≠do</div><h2>' + resTitle + '</h2><div class="ganho-destaque">+' + ganho + ' CM</div><p class="subtitle">Em apenas 30 dias com o M√©todo TRIPE</p><button class="cta-btn" onclick="window.finish()">' + ctaText + '</button></div>';
            trackMetric('optimization/variants/resultado_' + selectedVariants.resultado + '/completed');
            trackMetric('optimization/variants/cta_' + selectedVariants.cta + '/completed');
        }

        async function init() {
            try {
                const appInstance = initializeApp(firebaseConfig);
                db = getDatabase(appInstance);
                userRef = ref(db, 'sessions/' + sessionId);

                const statsSnap = await get(ref(db, 'optimization/stats/total_sessions'));
                const totalSessions = (statsSnap.val() || 0) + 1;
                await update(ref(db, 'optimization/stats'), { total_sessions: totalSessions });

                const variantIdx = Math.floor((totalSessions / 10) % 5);
                selectedVariants.saudacao = variantIdx;
                selectedVariants.resultado = variantIdx;
                selectedVariants.cta = variantIdx;
                selectedVariants.questions = [variantIdx, variantIdx, variantIdx, variantIdx, variantIdx, variantIdx, variantIdx];

                const winnerSnap = await get(ref(db, 'optimization/winner'));
                if (winnerSnap.exists()) {
                    const winner = winnerSnap.val();
                    selectedVariants.saudacao = winner.saudacao;
                    selectedVariants.resultado = winner.resultado;
                    selectedVariants.cta = winner.cta;
                }

                await set(userRef, { enteredAt: serverTimestamp(), status: 'active', variants: selectedVariants });
                trackMetric('optimization/variants/saudacao_' + selectedVariants.saudacao + '/tests');
                render();
            } catch (e) { console.error(e); render(); }
        }

        window.selectOption = (id, val) => { answers[id] = val; render(); };
        window.next = () => { currentStep++; render(); };
        window.prev = () => { currentStep--; render(); };
        window.finish = async () => {
            if (userRef) {
                await update(userRef, { currentStep: 99, status: 'converted', lastUpdate: serverTimestamp() });
                trackMetric('optimization/variants/resultado_' + selectedVariants.resultado + '/converted');
                trackMetric('optimization/variants/cta_' + selectedVariants.cta + '/converted');
            }
            window.location.href = "https://pay.wiapy.com/w-U6oehEBd";
        };
        init( );
    </script>
</body>
</html>
